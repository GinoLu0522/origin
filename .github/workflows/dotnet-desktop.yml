name: .NET + GPT Code Review

on:
  pull_request:
    branches: [ "feature1" ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build-and-test:
    runs-on: windows-latest
    env:
      Solution_Name: WebServer.sln                # ✅ 替換為你的 .sln 名稱
      Test_Project_Path: server/WebServer/WebServer/WebServer.csproj  # ✅ 替換為你的 test 專案路徑

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup .NET 8 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore ${{ env.Solution_Name }}

      - name: Build solution
        run: dotnet build ${{ env.Solution_Name }} --configuration Release --no-restore

      - name: Run tests
        run: dotnet test ${{ env.Test_Project_Path }} --no-build --verbosity normal

  gpt-code-review:
    name: GPT Auto Code Review (C#)
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'pull_request'

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get C# file diffs
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.cs' > cs.diff || true
          if [ ! -s cs.diff ]; then
            echo "NO_CHANGES" > decision.txt
            exit 0
          fi

      - name: Ask GPT for review
        id: review
        run: |
          prompt="你是資深 C# 工程師，請針對以下程式碼變更提供建議（若無問題請回覆 approve）：\n\n$(cat cs.diff)"
          response=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4o",
              "messages": [
                {"role": "system", "content": "你是資深 C# 工程師"},
                {"role": "user", "content": "'"$prompt"'"}
              ],
              "temperature": 0.3
            }' | jq -r '.choices[0].message.content')
          echo "$response" > review.txt
          echo "$response"
          if echo "$response" | grep -iq "request-changes"; then
            echo "request-changes" > decision.txt
          else
            echo "approve" > decision.txt
          fi

      - name: Leave review on PR
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO=${{ github.repository }}
          decision=$(cat decision.txt)
          if [[ "$decision" == "approve" ]]; then
            gh pr review "$PR_NUMBER" --repo "$REPO" --approve --body-file review.txt
          elif [[ "$decision" == "request-changes" ]]; then
            gh pr review "$PR_NUMBER" --repo "$REPO" --request-changes --body-file review.txt
          else
            gh pr comment "$PR_NUMBER" --repo "$REPO" --body-file review.txt
          fi
